{% extends 'base.html' %}
{% block content %}
<div class="chat-shell">
  <div class="col-12">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><h5>{{ room }}</h5><small class="text-muted">Ø£Ù†Øª: <strong>{{ user }}</strong></small></div>
        <div><small id="onlineCount" class="text-muted">...</small></div>
      </div>

      <div id="messages" class="messages mb-2"></div>

      <div class="d-flex gap-2 align-items-center">
        <button id="recordBtn" class="btn btn-outline-secondary">ðŸŽ™</button>
        <input id="msg" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
        <button id="sendBtn" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();
const room = "{{ room }}";
let user = "{{ user }}";
const role = "{{ role if role else 'user' }}";
const messagesDiv = document.getElementById('messages');
const onlineCount = document.getElementById('onlineCount');

socket.emit('join', {room: room, user: user, role: role});

// handle incoming messages
socket.on('message', function(d){
  if(d.type === 'notice'){
    messagesDiv.innerHTML += `<div class="text-center text-muted small my-1">${d.msg}</div>`;
  } else if(d.type === 'message'){
    const isMe = d.user === user;
    const cls = isMe ? 'bubble me' : 'bubble other';
    messagesDiv.innerHTML += `<div class="${cls}"><div class="meta"><strong>${d.user}</strong></div><div class="text">${d.msg}</div></div>`;
  } else if(d.type === 'audio'){
    const isMe = d.user === user;
    const cls = isMe ? 'bubble me' : 'bubble other';
    messagesDiv.innerHTML += `<div class="${cls}"><div class="meta"><strong>${d.user}</strong></div><div class="text"><audio controls src="${d.url}"></audio></div></div>`;
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// members update
socket.on('members_update', function(obj){
  if(obj.room !== room) return;
  onlineCount.textContent = obj.members.length + " Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„";
  fetch('/api/members/' + encodeURIComponent(room)).then(r=>r.json()).then(list=>{
    // optionally show members side list
  });
});

// load history
fetch('/api/messages/' + encodeURIComponent(room)).then(r=>r.json()).then(list=>{
  messagesDiv.innerHTML = '';
  list.forEach(it=>{
    if(it.type === 'text'){
      const cls = it.user === user ? 'bubble me' : 'bubble other';
      messagesDiv.innerHTML += `<div class="${cls}"><div class="meta"><strong>${it.user}</strong></div><div class="text">${it.content}</div></div>`;
    } else if(it.type === 'audio'){
      const cls = it.user === user ? 'bubble me' : 'bubble other';
      messagesDiv.innerHTML += `<div class="${cls}"><div class="meta"><strong>${it.user}</strong></div><div class="text"><audio controls src="/uploads/${it.content}"></audio></div></div>`;
    }
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// send text
document.getElementById('sendBtn').addEventListener('click', function(){
  const msg = document.getElementById('msg').value.trim();
  if(!msg) return;
  socket.emit('chat', {room: room, user: user, role: role, msg: msg});
  document.getElementById('msg').value = '';
});

// audio recording + upload
let mediaRecorder = null, chunks = [];
const recordBtn = document.getElementById('recordBtn');
recordBtn.addEventListener('click', async () => {
  if(!mediaRecorder){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        chunks = [];
        const fd = new FormData();
        fd.append('audio', blob, 'voice.webm');
        fd.append('room', room);
        fd.append('user', user);
        fd.append('role', role);
        const res = await fetch('/upload_audio', { method: 'POST', body: fd });
        // server emits audio message to room
      };
      mediaRecorder.start();
      recordBtn.textContent = 'â¸ Ø¥ÙŠÙ‚Ø§Ù';
    } catch(e){
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
    }
  } else {
    mediaRecorder.stop();
    mediaRecorder = null;
    recordBtn.textContent = 'ðŸŽ™';
  }
});

// leave room on unload
window.addEventListener('beforeunload', ()=> {
  try{ socket.emit('leave', {room: room, user: user}); }catch(e){}
});
</script>
{% endblock %}
