<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© â€” ChatApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div class="chat-app">
    <aside class="sidebar">
      <div class="user-info">
        <div class="avatar">ğŸ‘¤</div>
        <div>
          <div class="username">{{ username }}</div>
          <a href="/logout" class="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
        </div>
      </div>
      <h3 class="section-title">Ø§Ù„ØºØ±Ù</h3>
      <ul class="room-list" id="roomList">
        <li class="active" data-room="Ø¹Ø§Ù…">Ø¹Ø§Ù…</li>
        <li data-room="Ø£ØµØ¯Ù‚Ø§Ø¡">Ø£ØµØ¯Ù‚Ø§Ø¡</li>
        <li data-room="Ø¯Ø±Ø§Ø³Ø©">Ø¯Ø±Ø§Ø³Ø©</li>
      </ul>
    </aside>

    <main class="chat-area">
      <header class="chat-header">
        <h2 id="roomTitle">Ø¹Ø§Ù…</h2>
      </header>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <input id="msgInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
        <button id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </main>
  </div>

  <script>
    const USERNAME = "{{ username }}";
    let currentRoom = "Ø¹Ø§Ù…";
    const socket = io();

    const roomList = document.getElementById("roomList");
    const messages = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const roomTitle = document.getElementById("roomTitle");

    // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©
    function addMessage(sender, content, time){
      const div = document.createElement("div");
      div.classList.add("msg", sender === USERNAME ? "you" : "other");
      div.innerHTML = `<div class="bubble"><b>${sender}</b><br>${content}<br><small>${time}</small></div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºØ±ÙØ©
    function loadMessages(room){
      fetch(`/api/messages/${room}`)
        .then(res => res.json())
        .then(data => {
          messages.innerHTML = "";
          data.forEach(m => addMessage(m.sender, m.content, m.created_at));
        });
    }

    // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
    function joinRoom(room){
      currentRoom = room;
      roomTitle.textContent = room;
      messages.innerHTML = "";
      socket.emit("join_room", {room: room, username: USERNAME});
      loadMessages(room);
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if(!text) return;
      socket.emit("send_message", {room: currentRoom, username: USERNAME, content: text});
      msgInput.value = "";
    };

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    socket.on("new_message", data => {
      if(data.room === currentRoom){
        addMessage(data.sender, data.content, data.created_at);
      }
    });

    socket.on("system", data => {
      addMessage("SYSTEM", data.msg, "");
    });

    // Ø§Ø®ØªÙŠØ§Ø± ØºØ±ÙØ©
    roomList.addEventListener("click", e=>{
      if(e.target.tagName === "LI"){
        document.querySelectorAll(".room-list li").forEach(li=>li.classList.remove("active"));
        e.target.classList.add("active");
        joinRoom(e.target.dataset.room);
      }
    });

    // Ø§Ù†Ø¶Ù…Ø§Ù… Ø£ÙˆÙ„ÙŠ
    joinRoom(currentRoom);
  </script>
</body>
</html>
