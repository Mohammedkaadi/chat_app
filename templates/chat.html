{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-md-4">
    <div class="card p-3">
      <h5>{{ room }}</h5>
      <div id="usersList"></div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card p-3">
      <div id="messages" class="messages" style="height:420px;overflow:auto;"></div>
      <div class="d-flex mt-2">
        <input id="msg" class="form-control me-2" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
        <button id="sendBtn" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<audio id="msgSound" src="{{ url_for('static', filename='ding.mp3') }}"></audio>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();
const room = "{{ room }}";
const user = "{{ user }}";
const role = "{{ role if role else 'user' }}";
const soundEnabled = "{{ session.get('sound','on') }}" === "on";
const messagesDiv = document.getElementById('messages');
const usersList = document.getElementById('usersList');
const msgSound = document.getElementById('msgSound');

socket.emit('join', {room: room, user: user, role: role});

socket.on('message', function(data){
  if(data.type === 'notice'){
    messagesDiv.innerHTML += `<div class="text-muted small">${data.msg}</div>`;
  } else if(data.type === 'message'){
    const isMe = data.user === user;
    const cls = isMe ? 'text-end text-primary' : 'text-start';
    messagesDiv.innerHTML += `<div class="${cls}"><strong>${data.user}</strong>: ${data.msg}</div>`;
    if(!isMe && soundEnabled){ msgSound.play(); }
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

socket.on('user_list', function(users){
  usersList.innerHTML = '<h6>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†:</h6><ul>';
  users.forEach(u=>{
    usersList.innerHTML += `<li>ðŸŸ¢ ${u}</li>`;
  });
  usersList.innerHTML += '</ul>';
});

document.getElementById('sendBtn').addEventListener('click', function(){
  const msg = document.getElementById('msg').value;
  if(!msg) return;
  socket.emit('chat', {room: room, user: user, role: role, msg: msg});
  document.getElementById('msg').value = '';
});
</script>
{% endblock %}
