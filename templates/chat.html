{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-md-4">
    <div class="card p-3">
      <h5>{{ room }}</h5>
      <div class="text-muted">Ø£Ù†Øª: <strong>{{ user }}</strong></div>
      <hr>
      <div id="usersList"><small class="text-muted">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ØºÙŠØ± Ù…ÙØ¹Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</small></div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card p-3">
      <div id="messages" class="messages" style="height:420px;overflow:auto;"></div>
      <div class="toolbar d-flex gap-2 align-items-center mt-2">
        <button class="btn btn-light"><i class="fa-solid fa-microphone"></i></button>
        <button class="btn btn-light"><i class="fa-solid fa-video"></i></button>
        <button class="btn btn-light"><i class="fa-solid fa-plus"></i></button>
        <input id="msg" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
        <button id="sendBtn" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous"></script>
<script>
  const socket = io();
  const room = "{{ room }}";
  const user = "{{ user }}";
  const role = "{{ role if role else 'user' }}";
  const messagesDiv = document.getElementById('messages');
  socket.emit('join', {room: room, user: user, role: role});

  socket.on('message', function(data){
    if(data.type === 'notice'){
      messagesDiv.innerHTML += `<div class="notice">${data.msg}</div>`;
    } else if(data.type === 'message'){
      const isMe = data.user === user;
      const cls = isMe ? 'bubble me' : 'bubble other';
      messagesDiv.innerHTML += `<div class="${cls}"><div class="meta"><strong>${data.user}</strong> <span class="role">${data.role==='admin'?'ğŸ‘‘':''}</span></div><div class="text">${data.msg}</div></div>`;
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  document.getElementById('sendBtn').addEventListener('click', function(){
    const msg = document.getElementById('msg').value;
    if(!msg) return;
    socket.emit('chat', {room: room, user: user, role: role, msg: msg});
    document.getElementById('msg').value = '';
  });

  // load history
  fetch('/api/messages/' + encodeURIComponent(room)).then(r=>r.json()).then(list=>{
    list.forEach(it=>{
      const isMe = it.user === user;
      const cls = isMe ? 'bubble me' : 'bubble other';
      messagesDiv.innerHTML += `<div class="${cls}"><div class="meta"><strong>${it.user}</strong> <span class="role">${it.role==='admin'?'ğŸ‘‘':''}</span></div><div class="text">${it.content}</div></div>`;
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
</script>
{% endblock %}
