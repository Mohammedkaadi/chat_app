{% extends 'base.html' %}
{% block content %}
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h5 class="mb-0">{{ room }}</h5>
      <small class="text-muted">Ø£Ù†Øª: <strong>{{ user }}</strong></small>
    </div>
    <div><small id="onlineCount" class="text-muted">...</small></div>
  </div>

  <div id="messages" class="messages mb-2"></div>

  <div class="chat-input">
    <button id="recordBtn" class="btn-record" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ">ðŸŽ™</button>
    <input id="msg" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
    <button id="sendBtn" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<audio id="notify" src="{{ url_for('static', filename='ding.mp3') }}" preload="auto"></audio>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();
const room = "{{ room }}";
let user = "{{ user }}";
const role = "{{ role if role else 'user' }}";
const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msg');
const notify = document.getElementById('notify');

socket.emit('join', {room: room, user: user, role: role});

// load history
fetch('/api/messages/' + encodeURIComponent(room)).then(r=>r.json()).then(list=>{
  messagesDiv.innerHTML = '';
  list.forEach(it=>{
    if(it.type === 'text'){
      const cls = it.user === user ? 'message you' : 'message other';
      messagesDiv.innerHTML += `<div class="${cls}"><strong>${it.user}</strong><div>${it.content}</div></div>`;
    } else if(it.type === 'audio'){
      const cls = it.user === user ? 'message you' : 'message other';
      messagesDiv.innerHTML += `<div class="${cls}"><strong>${it.user}</strong><div><audio controls src="/uploads/${it.content}"></audio></div></div>`;
    }
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// socket messages
socket.on('message', function(d){
  if(d.type === 'notice'){
    messagesDiv.innerHTML += `<div class="text-muted small text-center my-1">${d.msg}</div>`;
  } else if(d.type === 'message'){
    const isMe = d.user === user;
    const cls = isMe ? 'message you' : 'message other';
    messagesDiv.innerHTML += `<div class="${cls}"><strong>${d.user}</strong><div>${d.msg}</div></div>`;
    if(!isMe && "{{ session.get('sound','on') }}" === "on") notify.play();
  } else if(d.type === 'audio'){
    const isMe = d.user === user;
    const cls = isMe ? 'message you' : 'message other';
    messagesDiv.innerHTML += `<div class="${cls}"><strong>${d.user}</strong><div><audio controls src="${d.url}"></audio></div></div>`;
    if(!isMe && "{{ session.get('sound','on') }}" === "on") notify.play();
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

document.getElementById('sendBtn').addEventListener('click', ()=>{
  const txt = msgInput.value.trim();
  if(!txt) return;
  socket.emit('chat', {room: room, user: user, role: role, msg: txt});
  msgInput.value = '';
});

// recording
let mediaRecorder = null, chunks = [];
const recordBtn = document.getElementById('recordBtn');
recordBtn.addEventListener('click', async ()=>{
  if(!mediaRecorder){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' }); chunks = [];
        const fd = new FormData();
        fd.append('audio', blob, 'voice.webm');
        fd.append('room', room); fd.append('user', user); fd.append('role', role);
        await fetch('/upload_audio', { method: 'POST', body: fd });
      };
      mediaRecorder.start();
      recordBtn.textContent = 'â¸';
    } catch(e){
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
    }
  } else {
    mediaRecorder.stop();
    mediaRecorder = null;
    recordBtn.textContent = 'ðŸŽ™';
  }
});

window.addEventListener('beforeunload', ()=> { try{ socket.emit('leave', {room: room, user: user}); } catch(e){} });
</script>
{% endblock %}
