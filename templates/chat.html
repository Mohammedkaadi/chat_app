{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-md-4">
    <div class="card p-3">
      <h5>{{ room }}</h5>
      <div class="text-muted">Ø£Ù†Øª: <strong>{{ user }}</strong></div>
      <hr>
      <h6>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†</h6>
      <ul id="membersList" class="list-unstyled small text-muted">
        <li>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li>
      </ul>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card p-3">
      <div id="messages" class="messages" style="height:420px;overflow:auto;"></div>
      <div class="d-flex gap-2 mt-2 align-items-center">
        <button id="recordBtn" class="btn btn-light">ğŸ™ ØªØ³Ø¬ÙŠÙ„</button>
        <input id="msg" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
        <button id="sendBtn" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();
const room = "{{ room }}";
const user = "{{ user }}";
const role = "{{ role if role else 'user' }}";
const messagesDiv = document.getElementById('messages');
const membersList = document.getElementById('membersList');

socket.emit('join', {room: room, user: user, role: role});

socket.on('message', function(data){
  if(data.type === 'notice'){
    messagesDiv.innerHTML += `<div class="text-center text-muted small my-1">${data.msg}</div>`;
  } else if(data.type === 'message'){
    const isMe = data.user === user;
    const cls = isMe ? 'text-end text-primary' : 'text-start';
    messagesDiv.innerHTML += `<div class="${cls}"><strong>${data.user}</strong>: ${data.msg}</div>`;
  } else if(data.type === 'audio'){
    const isMe = data.user === user;
    const cls = isMe ? 'text-end' : 'text-start';
    messagesDiv.innerHTML += `<div class="${cls}"><strong>${data.user}</strong>: <audio controls src="${data.url}"></audio></div>`;
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

socket.on('members_update', function(d){
  if(d.room !== room) return;
  fetch('/api/members/' + encodeURIComponent(room)).then(r=>r.json()).then(list=>{
    membersList.innerHTML = '';
    if(list.length === 0) membersList.innerHTML = '<li class="text-muted small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…ØªØµÙ„ÙˆÙ†</li>';
    else list.forEach(m => membersList.innerHTML += `<li>ğŸŸ¢ ${m.user} ${m.role==='admin'?'(Ù…Ø¯ÙŠØ±)':''}</li>`);
  });
});

// load history
fetch('/api/messages/' + encodeURIComponent(room)).then(r=>r.json()).then(list=>{
  messagesDiv.innerHTML = '';
  list.forEach(it=>{
    if(it.type === 'text'){
      const cls = it.user === user ? 'text-end text-primary' : 'text-start';
      messagesDiv.innerHTML += `<div class="${cls}"><strong>${it.user}</strong>: ${it.content}</div>`;
    } else if(it.type === 'audio'){
      const cls = it.user === user ? 'text-end' : 'text-start';
      messagesDiv.innerHTML += `<div class="${cls}"><strong>${it.user}</strong>: <audio controls src="/uploads/${it.content}"></audio></div>`;
    }
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

document.getElementById('sendBtn').addEventListener('click', function(){
  const msg = document.getElementById('msg').value.trim();
  if(!msg) return;
  socket.emit('chat', {room: room, user: user, role: role, msg: msg});
  document.getElementById('msg').value = '';
});

///// Audio recording /////
let mediaRecorder = null;
let chunks = [];
const recordBtn = document.getElementById('recordBtn');

recordBtn.addEventListener('click', async () => {
  if(!mediaRecorder){
    // start recording
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        chunks = [];
        // upload via fetch
        const fd = new FormData();
        fd.append('audio', blob, 'voice.webm');
        fd.append('room', room);
        fd.append('user', user);
        fd.append('role', role);
        const res = await fetch('/upload_audio', { method: 'POST', body: fd });
        const j = await res.json();
        // server will emit socket message to room with type 'audio'
      };
      mediaRecorder.start();
      recordBtn.textContent = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
    } catch(e){
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
    }
  } else {
    // stop
    mediaRecorder.stop();
    mediaRecorder = null;
    recordBtn.textContent = 'ğŸ™ ØªØ³Ø¬ÙŠÙ„';
  }
});
</script>
{% endblock %}
